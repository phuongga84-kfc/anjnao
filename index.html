<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V√¨ b·∫°n ·∫•y x·ª©ng ƒë√°ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0; overflow: hidden; touch-action: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2d3748; user-select: none;
        }
        #gameCanvas {
            display: block; margin: 0 auto;
            background-size: cover; background-position: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: background-image 0.5s ease;
        }
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 50; transition: opacity 0.2s;
        }
        .hidden { display: none !important; }
        .btn { transition: all 0.1s; }
        .btn:active { transform: scale(0.95); }
        
        /* Tab Shop */
        .tab-btn { padding: 8px 12px; font-weight: bold; border-bottom: 3px solid transparent; opacity: 0.6; transition: 0.2s; }
        .tab-btn.active { opacity: 1; border-bottom-color: #f97316; color: #f97316; }
        .shop-item:hover { transform: translateY(-3px); }
        .shop-item.equipped { border-color: #22c55e; background-color: #f0fdf4; }

        /* Animation */
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Floating Text Animation */
        .float-text {
            position: absolute;
            font-weight: 900;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 20;
            text-shadow: 2px 2px 0 #fff;
            white-space: nowrap;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-800 h-screen w-screen flex justify-center items-center relative">

    <canvas id="gameCanvas"></canvas>
    
    <!-- Input ·∫©n ƒë·ªÉ upload ·∫£nh custom Character -->
    <input type="file" id="customCharInput" accept="image/png, image/jpeg" class="hidden">
    <!-- Input ·∫©n ƒë·ªÉ upload ·∫£nh custom Background -->
    <input type="file" id="customBgInput" accept="image/png, image/jpeg" class="hidden">

    <!-- N√∫t Pause -->
    <button id="pauseBtn" onclick="togglePause()" class="hidden absolute top-4 right-4 z-40 bg-white/90 text-gray-800 p-3 rounded-full shadow-lg border-2 border-gray-300 w-12 h-12 flex items-center justify-center hover:bg-gray-100 btn">
        <i class="fas fa-pause text-xl"></i>
    </button>

    <!-- HUD -->
    <div id="hud" class="absolute top-0 left-0 w-full p-2 flex justify-between items-start hidden pointer-events-none z-10 gap-2 pr-16">
        <div class="bg-white/90 p-2 rounded-lg shadow border-b-4 border-orange-400 w-1/4 text-center">
            <p class="text-[10px] text-gray-600 font-bold uppercase">M√°u</p>
            <p id="scoreDisplay" class="text-xl font-black text-orange-600">10</p>
        </div>
        <div class="bg-white/90 p-2 rounded-lg shadow border-b-4 border-purple-400 w-1/4 text-center">
            <p class="text-[10px] text-gray-600 font-bold uppercase">Th·ªùi gian</p>
            <p id="timeDisplay" class="text-xl font-black text-purple-600">60</p>
        </div>
        <div class="bg-white/90 p-2 rounded-lg shadow border-b-4 border-blue-400 w-1/4 text-center">
            <p class="text-[10px] text-gray-600 font-bold uppercase">ƒêi·ªÉm</p>
            <p id="pointsDisplay" class="text-xl font-black text-blue-600">0</p>
        </div>
        <div class="bg-white/90 p-2 rounded-lg shadow border-b-4 border-green-500 w-1/4 text-center">
            <p class="text-[10px] text-gray-600 font-bold uppercase">Ti·ªÅn</p>
            <p id="sessionMoneyDisplay" class="text-xl font-black text-green-600">+$0</p>
        </div>
    </div>
    
    <!-- Buff Status UI -->
    <div id="buffContainer" class="absolute top-20 left-2 space-y-1 pointer-events-none z-10 text-left"></div>

    <!-- MAIN MENU -->
    <div id="mainMenu" class="overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-[90%] animate-bounce-in border-4 border-white/20 relative">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-2">CHO B·∫†N NGHƒ®A ƒÇN C·ª®T</h1>
            
            <div class="mb-6 bg-green-100 py-3 rounded-lg border border-green-300 shadow-inner">
                <p class="text-xs text-green-600 font-bold uppercase">T√†i kho·∫£n ch√≠nh</p>
                <p class="text-3xl font-black text-green-700">$<span id="totalMoneyDisplay">0</span></p>
            </div>

            <div class="space-y-3 w-full">
                <button onclick="AudioSys.play('click'); showDifficultyMenu()" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-blue-700 text-lg">
                    <i class="fas fa-play mr-2"></i> CH∆†I NGAY
                </button>
                
                <button onclick="AudioSys.play('click'); openShop()" class="btn w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-purple-700 text-lg">
                    <i class="fas fa-store mr-2"></i> C·ª¨A H√ÄNG
                </button>

                <button onclick="AudioSys.play('click'); openTutorial()" class="btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-yellow-700 text-lg">
                    <i class="fas fa-book mr-2"></i> H∆Ø·ªöNG D·∫™N
                </button>

                <button onclick="AudioSys.play('click'); openSettings('main')" class="btn w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-gray-700 text-lg">
                    <i class="fas fa-cog mr-2"></i> C√ÄI ƒê·∫∂T
                </button>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MENU -->
    <div id="tutorialMenu" class="overlay hidden">
        <div class="bg-white rounded-2xl shadow-2xl text-center max-w-md w-[95%] h-[85%] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50">
                <h2 class="text-xl font-black text-gray-800">H∆Ø·ªöNG D·∫™N CH∆†I</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 text-left space-y-4 bg-gray-50">
                
                <div class="bg-white p-3 rounded-lg shadow-sm border">
                    <p class="font-bold text-gray-700 mb-2">1. C√°ch ch∆°i</p>
                    <p class="text-sm text-gray-600">Di chuy·ªÉn nh√¢n v·∫≠t ƒë·ªÉ h·ª©ng ƒë·ªì ƒÉn t·ªët. Tr√°nh n√© ƒë·ªì ƒÉn thiu v√† c√°c v·∫≠t ph·∫©m nguy hi·ªÉm.</p>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg shadow-sm border border-blue-200">
                    <p class="font-bold text-blue-700 mb-2">2. Buff (L·ª£i - ƒÇn v√†o s∆∞·ªõng)</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-3"><span class="text-2xl">üí∞</span> <span><b>x2 Ti·ªÅn (5s):</b> Nh√¢n ƒë√¥i ti·ªÅn nh·∫∑t ƒë∆∞·ª£c.</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">‚≠ê</span> <span><b>x2 ƒêi·ªÉm (5s):</b> Nh√¢n ƒë√¥i ƒëi·ªÉm s·ªë.</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">üßä</span> <span><b>L√†m ch·∫≠m:</b> ƒê·ªì r∆°i ch·∫≠m l·∫°i trong 5s.</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">üíé</span> <span><b>+50% Ti·ªÅn:</b> TƒÉng ngay 50% s·ªë ti·ªÅn ƒëang c√≥.</span></div>
                    </div>
                </div>

                <div class="bg-red-50 p-3 rounded-lg shadow-sm border border-red-200">
                    <p class="font-bold text-red-700 mb-2">3. Debuff (H·∫°i - ƒÇn v√†o kh·ªï)</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-3"><span class="text-2xl">‚ö°</span> <span><b>TƒÉng t·ªëc:</b> ƒê·ªì r∆°i nhanh g·∫•p ƒë√¥i trong 5s.</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">üí∏</span> <span><b>-50% Ti·ªÅn:</b> M·∫•t ngay 50% s·ªë ti·ªÅn ƒëang c√≥.</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">üíÄ</span> <span><b>T·ª≠ th·∫ßn:</b> Thua ngay l·∫≠p t·ª©c!</span></div>
                    </div>
                </div>

            </div>
            <div class="p-3 border-t bg-white">
                <button onclick="AudioSys.play('click'); closeTutorial()" class="btn w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl">ƒê√É HI·ªÇU</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS, SHOP, DIFFICULTY, PAUSE, GAMEOVER MENUS -->
    <div id="settingsMenu" class="overlay hidden z-[60]">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-[85%]">
            <h2 class="text-2xl font-black text-gray-700 mb-6">C√ÄI ƒê·∫∂T</h2>
            <div class="mb-6 space-y-5">
                <div class="flex items-center justify-between border-b pb-2">
                    <div class="flex items-center text-gray-700 font-bold"><i class="fas fa-music w-6 text-center mr-2 text-blue-500"></i> Nh·∫°c n·ªÅn</div>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="musicToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" checked onchange="toggleMusic()"/><label for="musicToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div>
                </div>
                <div class="flex items-center justify-between border-b pb-2">
                    <div class="flex items-center text-gray-700 font-bold"><i class="fas fa-volume-up w-6 text-center mr-2 text-green-500"></i> Hi·ªáu ·ª©ng</div>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="sfxToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300" checked onchange="toggleSFX()"/><label for="sfxToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div>
                </div>
                <div class="text-left pt-2"><span class="text-sm font-bold text-gray-500 mb-2 block">√Çm l∆∞·ª£ng t·ªïng</span><div class="flex items-center gap-2"><i class="fas fa-volume-down text-gray-400"></i><input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5" oninput="changeVolume(this.value)"><i class="fas fa-volume-up text-gray-400"></i></div></div>
            </div>
            <button onclick="AudioSys.play('click'); closeSettings()" class="btn w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl shadow">XONG</button>
        </div>
    </div>

    <div id="pauseMenu" class="overlay hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-[90%] relative">
            <h2 class="text-3xl font-black text-gray-800 mb-4">T·∫†M D·ª™NG</h2>
            <div class="flex justify-center gap-4 mb-6">
                <div class="bg-blue-50 p-2 rounded w-1/2 border border-blue-200"><p class="text-[10px] text-gray-500 uppercase">ƒêi·ªÉm hi·ªán t·∫°i</p><p id="pauseScore" class="text-2xl font-black text-blue-600">0</p></div>
                <div class="bg-green-50 p-2 rounded w-1/2 border border-green-200"><p class="text-[10px] text-gray-500 uppercase">Ti·ªÅn hi·ªán t·∫°i</p><p id="pauseMoney" class="text-2xl font-black text-green-600">+0$</p></div>
            </div>
            <div class="space-y-3">
                <button onclick="AudioSys.play('click'); togglePause()" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg border-b-4 border-blue-700"><i class="fas fa-play mr-2"></i> TI·∫æP T·ª§C</button>
                <button onclick="AudioSys.play('click'); openSettings('pause')" class="btn w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-xl shadow-lg border-b-4 border-gray-700"><i class="fas fa-cog mr-2"></i> C√ÄI ƒê·∫∂T</button>
                <button onclick="AudioSys.play('click'); confirmQuit()" class="btn w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg border-b-4 border-red-700"><i class="fas fa-sign-out-alt mr-2"></i> THO√ÅT GAME</button>
            </div>
        </div>
    </div>

    <div id="confirmQuitMenu" class="overlay hidden z-[70]">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-[85%]">
            <div class="text-red-500 text-4xl mb-2"><i class="fas fa-exclamation-circle"></i></div>
            <h2 class="text-xl font-black text-gray-800 mb-2">B·∫†N CH·∫ÆC CH·ª®?</h2>
            <p class="text-gray-500 text-sm mb-6">M·ªçi ƒëi·ªÉm s·ªë v√† ti·ªÅn trong m√†n ch∆°i n√†y s·∫Ω b·ªã m·∫•t!</p>
            <div class="flex gap-3">
                <button onclick="AudioSys.play('click'); cancelQuit()" class="btn flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-xl">KH√îNG</button>
                <button onclick="AudioSys.play('click'); quitGame()" class="btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-xl shadow border-b-4 border-red-700">THO√ÅT</button>
            </div>
        </div>
    </div>

    <div id="difficultyMenu" class="overlay hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-[90%]">
            <h2 class="text-2xl font-black text-gray-700 mb-4">CH·ªåN ƒê·ªò KH√ì</h2>
            <div class="space-y-3 w-full mb-4">
                <button onclick="AudioSys.play('click'); startGame('easy')" class="btn w-full bg-green-50 text-green-800 font-bold py-3 rounded-xl border-2 border-green-500 hover:bg-green-100 text-left px-4 relative"><span class="block text-lg">D·ªÑ (Easy)</span><span class="text-xs text-green-600">+20$ / -15$</span><span class="absolute right-4 top-3 bg-green-200 px-2 rounded text-xs">Top: <span id="recordEasy">0</span></span></button>
                <button onclick="AudioSys.play('click'); startGame('medium')" class="btn w-full bg-yellow-50 text-yellow-800 font-bold py-3 rounded-xl border-2 border-yellow-500 hover:bg-yellow-100 text-left px-4 relative"><span class="block text-lg">TRUNG B√åNH</span><span class="text-xs text-yellow-600">+40$ / -25$</span><span class="absolute right-4 top-3 bg-yellow-200 px-2 rounded text-xs">Top: <span id="recordMedium">0</span></span></button>
                <button onclick="AudioSys.play('click'); startGame('hard')" class="btn w-full bg-red-50 text-red-800 font-bold py-3 rounded-xl border-2 border-red-500 hover:bg-red-100 text-left px-4 relative"><span class="block text-lg">KH√ì (Hard)</span><span class="text-xs text-red-600">+80$ / -60$</span><span class="absolute right-4 top-3 bg-red-200 px-2 rounded text-xs">Top: <span id="recordHard">0</span></span></button>
            </div>
            <button onclick="AudioSys.play('click'); backToMain()" class="text-gray-400 font-bold text-sm hover:text-gray-600"><i class="fas fa-arrow-left"></i> QUAY L·∫†I</button>
        </div>
    </div>

    <div id="shopMenu" class="overlay hidden">
        <div class="bg-white rounded-2xl shadow-2xl text-center max-w-md w-[95%] h-[85%] flex flex-col overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h2 class="text-xl font-black text-gray-800">C·ª¨A H√ÄNG</h2><div class="bg-green-100 px-3 py-1 rounded-full text-green-700 font-bold border border-green-300">$<span id="shopMoneyDisplay">0</span></div></div>
            <div class="flex justify-around bg-white border-b"><button onclick="AudioSys.play('click'); switchShopTab('character')" id="tab-character" class="tab-btn active w-1/3">NH√ÇN V·∫¨T</button><button onclick="AudioSys.play('click'); switchShopTab('background')" id="tab-background" class="tab-btn w-1/3">N·ªÄN</button><button onclick="AudioSys.play('click'); switchShopTab('items')" id="tab-items" class="tab-btn w-1/3">V·∫¨T PH·∫®M</button></div>
            <div id="shopList" class="flex-1 overflow-y-auto space-y-2 p-3 bg-gray-50"></div>
            <div class="p-3 border-t bg-white"><button onclick="AudioSys.play('click'); backToMain()" class="btn w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl"><i class="fas fa-check"></i> XONG</button></div>
        </div>
    </div>

    <div id="gameOverMenu" class="overlay hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-[90%] animate-bounce-in">
            <h2 id="endReason" class="text-lg font-bold text-gray-500">GAME OVER!</h2>
            <div class="flex justify-center items-end gap-2 mb-4"><div class="text-center"><p class="text-xs text-gray-400 uppercase">ƒêi·ªÉm s·ªë</p><p id="finalScore" class="text-4xl font-black text-blue-600">0</p></div></div>
            <div class="bg-gray-100 p-4 rounded-xl mb-4 border-2 border-gray-200">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">T·ªïng k·∫øt ti·ªÅn</p>
                <div class="flex justify-between items-center text-sm mb-2"><span>Ki·∫øm ƒë∆∞·ª£c:</span><span id="finalMoneyEarned" class="font-bold text-green-600">+0$</span></div>
                <div class="border-t border-gray-300 my-2"></div>
                <div class="flex justify-between items-center"><span class="font-bold text-gray-700">S·ªë d∆∞ m·ªõi:</span><span id="finalTotalMoney" class="font-black text-green-700 text-xl">0$</span></div>
            </div>
            <button onclick="AudioSys.play('click'); backToMain()" class="btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-blue-700 mb-2"><i class="fas fa-home"></i> MENU CH√çNH</button>
             <button onclick="AudioSys.play('click'); replayGame()" class="btn w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl"><i class="fas fa-redo"></i> CH∆†I L·∫†I</button>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH T·ª∂ L·ªÜ ---
        const GAME_CONFIG = {
            specialItemChance: 0.20, // 20% c∆° h·ªôi sinh ra item Buff/Debuff thay v√¨ item th∆∞·ªùng
            
            // Tr·ªçng s·ªë (Weight) xu·∫•t hi·ªán c·ªßa t·ª´ng lo·∫°i item (s·ªë c√†ng to c√†ng d·ªÖ ra)
            specialWeights: {
                // BUFFS (C√≥ l·ª£i)
                money_x2: 15,      // x2 ti·ªÅn (5s)
                points_x2: 15,     // x2 ƒëi·ªÉm (5s)
                slow_motion: 15,   // l√†m ch·∫≠m (5s)
                instant_money: 10, // +50% ti·ªÅn (ngay l·∫≠p t·ª©c)
                
                // DEBUFFS (C√≥ h·∫°i)
                fast_motion: 20,   // tƒÉng t·ªëc x2 (5s)
                lose_money: 20,    // -50% ti·ªÅn (ngay l·∫≠p t·ª©c)
                instant_death: 5   // thua lu√¥n (r·∫•t hi·∫øm)
            }
        };

        // Danh s√°ch Icon (Emoji) cho c√°c item ƒë·∫∑c bi·ªát
        const SPECIAL_ITEMS_INFO = {
            money_x2: { icon: 'üí∞', text: 'x2 TI·ªÄN (5s)', color: '#FFD700', type: 'buff' },
            points_x2: { icon: '‚≠ê', text: 'x2 ƒêI·ªÇM (5s)', color: '#00BFFF', type: 'buff' },
            slow_motion: { icon: 'üßä', text: 'CH·∫¨M L·∫†I', color: '#ADD8E6', type: 'buff' },
            instant_money: { icon: 'üíé', text: '+50% TI·ªÄN', color: '#00FF7F', type: 'buff' },
            fast_motion: { icon: '‚ö°', text: 'NHANH QU√Å!', color: '#FF4500', type: 'debuff' },
            lose_money: { icon: 'üí∏', text: '-50% TI·ªÄN', color: '#DC143C', type: 'debuff' },
            instant_death: { icon: 'üíÄ', text: 'T·ª¨ TH·∫¶N!', color: '#000000', type: 'debuff' }
        };

        // --- 1. H·ªÜ TH·ªêNG √ÇM THANH SYNTH ---
        const AudioSys = {
            ctx: null,
            musicOn: true,
            sfxOn: true,
            volume: 0.5,
            init: function() { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); },
            play: function(type) {
                if (!this.sfxOn && type !== 'bgm') return;
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                const vol = this.volume;

                if (type === 'click') { osc.frequency.setValueAtTime(800, t); osc.frequency.exponentialRampToValueAtTime(300, t+0.1); gain.gain.setValueAtTime(0.1*vol, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.1); } 
                else if (type === 'eat') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, t); osc.frequency.linearRampToValueAtTime(1200, t+0.1); gain.gain.setValueAtTime(0.1*vol, t); gain.gain.linearRampToValueAtTime(0.01, t+0.2); osc.start(t); osc.stop(t+0.2); }
                else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, t); osc.frequency.linearRampToValueAtTime(50, t+0.3); gain.gain.setValueAtTime(0.2*vol, t); gain.gain.linearRampToValueAtTime(0.01, t+0.3); osc.start(t); osc.stop(t+0.3); }
                else if (type === 'powerup') { osc.type = 'square'; osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(800, t+0.2); gain.gain.setValueAtTime(0.1*vol, t); gain.gain.linearRampToValueAtTime(0.01, t+0.2); osc.start(t); osc.stop(t+0.2); }
                else if (type === 'debuff') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(100, t+0.3); gain.gain.setValueAtTime(0.2*vol, t); gain.gain.linearRampToValueAtTime(0.01, t+0.3); osc.start(t); osc.stop(t+0.3); }
                else if (type === 'gameover') { osc.type = 'triangle'; osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(100, t+1); gain.gain.setValueAtTime(0.2*vol, t); gain.gain.linearRampToValueAtTime(0.01, t+1); osc.start(t); osc.stop(t+1); }
            }
        };

        // --- 2. C·∫§U H√åNH GAME & SHOP ---
        const SHOPS = {
            character: [
                { id: 'char_default', name: 'Cho t√¥i c·ª©t', price: 0, src: 'player/b.png' },
                { id: 'char_head', name: 'Nh√©t c·ª©t ƒë·∫ßu t√¥i', price: 20000, src: 'player/a.png' },
                // M·ª•c Custom Character m·ªõi
                { id: 'char_custom', name: 'T·ª± ch·ªçn (Upload)', price: 30000, src: '', isCustom: true }
            ],
            background: [
                { id: 'bg_default', name: 'Cho t√¥i c·ª©t', price: 0, src: 'background/ab1.jpg' },
                { id: 'bg_beach', name: 'T·ªõ xin l·ªói', price: 30000, src: 'background/ab.jpg' },
                { id: 'bg_space', name: 'V≈© Tr·ª•', price: 100000, src: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2072&auto=format&fit=crop' },
                // M·ª•c Custom Background m·ªõi
                { id: 'bg_custom', name: 'T·ª± ch·ªçn (Upload)', price: 40000, src: '', isCustom: true }
            ],
            items: [
                { id: 'item_default', name: 'M·∫∑c ƒë·ªãnh', price: 0, goodImgs: ['item/bad/shit.png'], badImgs: ['item/good/rice.png','item/good/orange-juice.png','item/good/pizza.png'] },
                { id: 'item_stone', name: 'ƒê√°', price: 10000, goodImgs: ['item/bad/stone.png'], badImgs: ['item/good/apple.png','item/good/banana.png','item/good/orange.png'] },
                { id: 'item_gold', name: 'C·ª©t v√†ng', price: 30000, goodImgs: ['item/bad/gold_shit.png'], badImgs: ['item/good/apple.png','item/good/orange-juice.png','item/good/crab.png'] },
                { id: 'item_diamond', name: 'C·ª©t kim c∆∞∆°ng', price: 100000, goodImgs: ['item/bad/diamond_shit.png'], badImgs: ['item/good/rice.png','item/good/shrimp.png','item/good/orange-juice.png'] }
            ]
        };

        const DEFAULT_EMOJI_GOOD = "üçî";
        const DEFAULT_EMOJI_BAD = "üí£";

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let playerData = {
            money: 100,
            owned: ['char_default', 'bg_default', 'item_default'],
            equippedChar: 'char_default', equippedBg: 'bg_default', equippedItem: 'item_default',
            customCharData: null, // L∆∞u d·ªØ li·ªáu ·∫£nh custom character (base64)
            customBgData: null, // L∆∞u d·ªØ li·ªáu ·∫£nh custom background (base64)
            highScores: { easy: 0, medium: 0, hard: 0 }
        };

        const difficulties = {
            easy: { speedMin: 5, speedMax: 10, spawnRate: 60, penaltyMiss: 1, penaltyHit: 3, moneyGood: 20, moneyBad: 15 },
            medium: { speedMin: 10, speedMax: 15, spawnRate: 40, penaltyMiss: 3, penaltyHit: 5, moneyGood: 40, moneyBad: 25 },
            hard: { speedMin: 15, speedMax: 20, spawnRate: 25, penaltyMiss: 5, penaltyHit: 10, moneyGood: 80, moneyBad: 60 }
        };

        let gameLoopId, timerInterval;
        let score = 0, points = 0, sessionMoney = 0, timeLeft = 60;
        let isGameOver = false, isPaused = false;
        let frames = 0;
        let currentLevel = 'easy';
        let items = [];
        let currentShopTab = 'character';

        // --- BUFF STATE ---
        let activeBuffs = {
            moneyMultiplier: 1,
            scoreMultiplier: 1,
            globalSpeedModifier: 1
        };
        let buffTimeouts = {};

        let imgChar = new Image();
        let goodImages = []; 
        let badImages = [];
        let loadedAssets = { char: false, good: false, bad: false };
        const player = { x: 0, y: 0, width: 80, height: 80, speed: 15, dx: 0 };

        // --- 3. LOGIC GAME C·ªêT L√ïI ---

        function loadData() {
            const saved = localStorage.getItem('catchGameData_v3');
            if (saved) playerData = { ...playerData, ...JSON.parse(saved) };
            updateGlobalUI();
        }
        function saveData() { localStorage.setItem('catchGameData_v3', JSON.stringify(playerData)); updateGlobalUI(); }
        function updateGlobalUI() { document.getElementById('totalMoneyDisplay').innerText = playerData.money; document.getElementById('shopMoneyDisplay').innerText = playerData.money; }
        
        function updateGraphics() {
            // -- Background --
            const bgData = SHOPS.background.find(i => i.id === playerData.equippedBg) || SHOPS.background[0];
            
            if (bgData.isCustom && playerData.customBgData) {
                canvas.style.backgroundImage = `url('${playerData.customBgData}')`;
            } else {
                canvas.style.backgroundImage = `url('${bgData.src}')`;
            }

            // -- Character --
            const charData = SHOPS.character.find(i => i.id === playerData.equippedChar) || SHOPS.character[0];
            
            if (charData.isCustom && playerData.customCharData) {
                imgChar.src = playerData.customCharData;
            } else {
                imgChar.src = charData.src; 
            }
            
            imgChar.onload = () => loadedAssets.char = true; 
            imgChar.onerror = () => {
                // N·∫øu custom ·∫£nh b·ªã l·ªói ho·∫∑c ch∆∞a c√≥, d√πng t·∫°m ·∫£nh m·∫∑c ƒë·ªãnh
                if (charData.isCustom) imgChar.src = SHOPS.character[0].src; 
                loadedAssets.char = false;
            };

            const itemData = SHOPS.items.find(i => i.id === playerData.equippedItem) || SHOPS.items[0];
            goodImages = []; badImages = [];
            if(itemData.goodImgs) itemData.goodImgs.forEach(src => { const img = new Image(); img.src = src; goodImages.push(img); });
            if(itemData.badImgs) itemData.badImgs.forEach(src => { const img = new Image(); img.src = src; badImages.push(img); });
        }

        function openSettings(source) { document.getElementById('settingsMenu').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settingsMenu').classList.add('hidden'); }
        function toggleMusic() { AudioSys.musicOn = !AudioSys.musicOn; }
        function toggleSFX() { AudioSys.sfxOn = !AudioSys.sfxOn; }
        function changeVolume(val) { AudioSys.volume = val; }

        function openTutorial() { document.getElementById('mainMenu').classList.add('hidden'); document.getElementById('tutorialMenu').classList.remove('hidden'); }
        function closeTutorial() { document.getElementById('tutorialMenu').classList.add('hidden'); document.getElementById('mainMenu').classList.remove('hidden'); }

        function togglePause() {
            if (isGameOver) return;
            isPaused = !isPaused;
            if (isPaused) {
                cancelAnimationFrame(gameLoopId); clearInterval(timerInterval);
                document.getElementById('pauseScore').innerText = points;
                document.getElementById('pauseMoney').innerText = (sessionMoney >= 0 ? "+" : "") + sessionMoney + "$";
                document.getElementById('pauseMenu').classList.remove('hidden');
            } else {
                document.getElementById('pauseMenu').classList.add('hidden'); document.getElementById('confirmQuitMenu').classList.add('hidden');
                gameLoop(); startTimer();
            }
        }
        function confirmQuit() { document.getElementById('confirmQuitMenu').classList.remove('hidden'); }
        function cancelQuit() { document.getElementById('confirmQuitMenu').classList.add('hidden'); }
        function quitGame() {
            isPaused = false;
            document.getElementById('pauseMenu').classList.add('hidden'); document.getElementById('confirmQuitMenu').classList.add('hidden');
            document.getElementById('hud').classList.add('hidden'); document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden'); document.getElementById('buffContainer').innerHTML = '';
            init();
        }

        // --- CUSTOM CHAR UPLOAD LOGIC ---
        document.getElementById('customCharInput').addEventListener('change', function(e) {
            handleUpload(e.target.files[0], 'char');
        });
        
        // --- CUSTOM BG UPLOAD LOGIC ---
        document.getElementById('customBgInput').addEventListener('change', function(e) {
            handleUpload(e.target.files[0], 'bg');
        });

        function handleUpload(file, type) {
            if (!file) return;
            // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc file (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert("File ·∫£nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 2MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                if (type === 'char') {
                    playerData.customCharData = event.target.result;
                    playerData.equippedChar = 'char_custom';
                } else {
                    playerData.customBgData = event.target.result;
                    playerData.equippedBg = 'bg_custom';
                }
                saveData();
                updateGraphics();
                renderShopItems();
                alert("ƒê√£ t·∫£i ·∫£nh l√™n th√†nh c√¥ng!");
            };
            reader.readAsDataURL(file);
        }

        // --- SHOP UI ---
        function switchShopTab(tab) {
            currentShopTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderShopItems();
        }
        function renderShopItems() {
            const list = document.getElementById('shopList'); list.innerHTML = '';
            const data = SHOPS[currentShopTab];
            data.forEach(item => {
                const isOwned = playerData.owned.includes(item.id);
                let isEquipped = false;
                if(currentShopTab === 'character') isEquipped = playerData.equippedChar === item.id;
                if(currentShopTab === 'background') isEquipped = playerData.equippedBg === item.id;
                if(currentShopTab === 'items') isEquipped = playerData.equippedItem === item.id;

                const div = document.createElement('div');
                div.className = `shop-item bg-white border-2 rounded-xl p-3 flex items-center justify-between shadow-sm ${isEquipped ? 'equipped' : 'border-gray-200'}`;
                
                let imgPreview = item.src;
                if (currentShopTab === 'items') imgPreview = item.goodImgs[0];
                
                // Logic hi·ªÉn th·ªã preview cho Custom Items
                if (item.isCustom) {
                    if (currentShopTab === 'character' && playerData.customCharData) imgPreview = playerData.customCharData;
                    else if (currentShopTab === 'background' && playerData.customBgData) imgPreview = playerData.customBgData;
                    else imgPreview = "https://cdn-icons-png.flaticon.com/512/126/126477.png"; // Icon m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a upload
                }

                let btnHtml = '';
                
                // N√∫t thao t√°c
                if (isEquipped) {
                     btnHtml = `<button class="bg-gray-300 text-gray-600 font-bold py-1 px-3 rounded text-xs cursor-not-allowed">ƒêang d√πng</button>`;
                     if (item.isCustom) {
                         const inputId = currentShopTab === 'character' ? 'customCharInput' : 'customBgInput';
                         btnHtml += `<button onclick="document.getElementById('${inputId}').click()" class="ml-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded text-xs shadow"><i class="fas fa-upload"></i> ƒê·ªïi ·∫£nh</button>`;
                     }
                } else if (isOwned) {
                    btnHtml = `<button onclick="AudioSys.play('click'); equipItem('${item.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-xs shadow">Ch·ªçn</button>`;
                    if (item.isCustom) {
                         const inputId = currentShopTab === 'character' ? 'customCharInput' : 'customBgInput';
                         btnHtml = `<button onclick="document.getElementById('${inputId}').click()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded text-xs shadow"><i class="fas fa-upload"></i> Up ·∫£nh</button> ` + btnHtml;
                    }
                } else {
                     btnHtml = `<button onclick="AudioSys.play('click'); buyItem('${item.id}', ${item.price})" class="${playerData.money >= item.price ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'} text-white font-bold py-1 px-3 rounded text-xs shadow">Mua $${item.price}</button>`;
                }

                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border"><img src="${imgPreview}" class="w-full h-full object-contain" onerror="this.src='https://via.placeholder.com/50'"></div><div class="text-left"><p class="font-bold text-gray-700 text-sm">${item.name}</p><p class="text-[10px] text-gray-400">${isOwned ? 'ƒê√£ s·ªü h·ªØu' : 'Gi√°: $' + item.price}</p></div></div><div class="flex">${btnHtml}</div>`;
                list.appendChild(div);
            });
        }
        function buyItem(id, price) { if (playerData.money >= price) { playerData.money -= price; playerData.owned.push(id); saveData(); renderShopItems(); } }
        function equipItem(id) {
            if(currentShopTab === 'character') playerData.equippedChar = id;
            if(currentShopTab === 'background') playerData.equippedBg = id;
            if(currentShopTab === 'items') playerData.equippedItem = id;
            saveData(); updateGraphics(); renderShopItems();
        }
        function openShop() { document.getElementById('mainMenu').classList.add('hidden'); document.getElementById('shopMenu').classList.remove('hidden'); switchShopTab('character'); }

        // --- GAMEPLAY ENGINE ---

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.y = canvas.height - player.height - 20; }
        window.addEventListener('resize', () => { resizeCanvas(); if(player.x > canvas.width - player.width) player.x = canvas.width - player.width; });

        document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') player.dx = -player.speed; if (e.key === 'ArrowRight') player.dx = player.speed; if (e.key === 'Escape') togglePause(); });
        document.addEventListener('keyup', (e) => { if(['ArrowLeft','ArrowRight'].includes(e.key)) player.dx = 0; });
        function handleInput(clientX) {
            if (isGameOver || isPaused) return;
            const rect = canvas.getBoundingClientRect();
            let rx = clientX - rect.left;
            player.x = rx - player.width/2;
            if (player.x < 0) player.x = 0; if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        }
        canvas.addEventListener('mousemove', e => handleInput(e.clientX));
        canvas.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e.touches[0].clientX); }, { passive: false });

        function init() {
            resizeCanvas(); loadData(); updateGraphics();
            player.x = canvas.width/2 - player.width/2;
            document.getElementById('recordEasy').innerText = playerData.highScores.easy;
            document.getElementById('recordMedium').innerText = playerData.highScores.medium;
            document.getElementById('recordHard').innerText = playerData.highScores.hard;
        }

        function startGame(level) {
            AudioSys.init();
            currentLevel = level;
            score = 30; points = 0; sessionMoney = 0; timeLeft = 60;
            items = []; isGameOver = false; isPaused = false; frames = 0;
            
            // Reset Buffs
            activeBuffs = { moneyMultiplier: 1, scoreMultiplier: 1, globalSpeedModifier: 1 };
            document.getElementById('buffContainer').innerHTML = '';
            
            document.getElementById('difficultyMenu').classList.add('hidden'); document.getElementById('gameOverMenu').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden'); document.getElementById('pauseBtn').classList.remove('hidden');
            
            updateHUD();
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoop(); startTimer();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (isGameOver || isPaused) return;
                timeLeft--; updateTimerHUD();
                if (timeLeft <= 0) endGame("H·∫æT GI·ªú!");
            }, 1000);
        }

        // --- SPAWN LOGIC (UPDATED WITH BUFFS) ---
        function spawnItem() {
            const diff = difficulties[currentLevel];
            const size = 50; 
            const x = Math.random() * (canvas.width - size);
            
            // Check Spawn Special
            if (Math.random() < GAME_CONFIG.specialItemChance) {
                // Ch·ªçn lo·∫°i special item d·ª±a tr√™n weights
                const rand = Math.random() * 100; // T·ªïng weight ~100
                let cumulative = 0;
                let selectedType = 'money_x2';
                
                for (const [key, weight] of Object.entries(GAME_CONFIG.specialWeights)) {
                    cumulative += weight;
                    if (rand <= cumulative) { selectedType = key; break; }
                }

                items.push({
                    x: x, y: -size, size: size,
                    type: 'special',
                    specialType: selectedType,
                    speed: (Math.random() * (diff.speedMax - diff.speedMin) + diff.speedMin) * 0.8 // Ch·∫≠m h∆°n x√≠u ƒë·ªÉ d·ªÖ nh√¨n
                });
            } else {
                // Spawn Normal
                const isBad = Math.random() < 0.50; 
                let imgIndex = 0;
                let targetArray = isBad ? badImages : goodImages;
                if (targetArray.length > 0) imgIndex = Math.floor(Math.random() * targetArray.length);

                items.push({ 
                    x: x, y: -size, size: size, 
                    type: isBad ? 'bad' : 'good',
                    isBad: isBad, 
                    imgIndex: imgIndex,
                    speed: Math.random() * (diff.speedMax - diff.speedMin) + diff.speedMin 
                });
            }
        }

        // --- APPLY BUFF EFFECT ---
        function applyBuff(type) {
            const info = SPECIAL_ITEMS_INFO[type];
            const isBuff = info.type === 'buff';
            
            AudioSys.play(isBuff ? 'powerup' : 'debuff');
            showFloatingText(info.text, player.x, player.y, info.color);
            addBuffIcon(info.icon, info.color);

            // X√≥a timeout c≈© n·∫øu c√≥ (ƒë·ªÉ reset th·ªùi gian)
            if (buffTimeouts[type]) clearTimeout(buffTimeouts[type]);

            switch (type) {
                case 'money_x2':
                    activeBuffs.moneyMultiplier = 2;
                    buffTimeouts[type] = setTimeout(() => { activeBuffs.moneyMultiplier = 1; removeBuffIcon(info.icon); }, 5000);
                    break;
                case 'points_x2':
                    activeBuffs.scoreMultiplier = 2;
                    buffTimeouts[type] = setTimeout(() => { activeBuffs.scoreMultiplier = 1; removeBuffIcon(info.icon); }, 5000);
                    break;
                case 'slow_motion':
                    activeBuffs.globalSpeedModifier = 0.5;
                    buffTimeouts[type] = setTimeout(() => { activeBuffs.globalSpeedModifier = 1; removeBuffIcon(info.icon); }, 5000);
                    break;
                case 'instant_money':
                    sessionMoney = Math.floor(sessionMoney * 1.5);
                    setTimeout(() => removeBuffIcon(info.icon), 500); // T·∫Øt icon nhanh
                    break;
                case 'fast_motion':
                    activeBuffs.globalSpeedModifier = 2.0;
                    buffTimeouts[type] = setTimeout(() => { activeBuffs.globalSpeedModifier = 1; removeBuffIcon(info.icon); }, 5000);
                    break;
                case 'lose_money':
                    sessionMoney = Math.floor(sessionMoney * 0.5);
                    setTimeout(() => removeBuffIcon(info.icon), 500);
                    break;
                case 'instant_death':
                    endGame("QU·ª≤ XU·ªêNG!");
                    break;
            }
        }

        function showFloatingText(text, x, y, color) {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function addBuffIcon(icon, color) {
            const container = document.getElementById('buffContainer');
            // Check if exists
            const existing = Array.from(container.children).find(el => el.dataset.icon === icon);
            if (!existing) {
                const el = document.createElement('div');
                el.dataset.icon = icon;
                el.className = "bg-white/90 p-1 px-2 rounded-lg shadow font-bold text-sm animate-bounce-in border-2";
                el.style.borderColor = color;
                el.innerHTML = `${icon}`;
                container.appendChild(el);
            }
        }
        function removeBuffIcon(icon) {
            const container = document.getElementById('buffContainer');
            const el = Array.from(container.children).find(el => el.dataset.icon === icon);
            if (el) el.remove();
        }

        function update() {
            frames++;
            if (player.dx !== 0) {
                player.x += player.dx;
                if (player.x < 0) player.x = 0; if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            }
            if (frames % difficulties[currentLevel].spawnRate === 0) spawnItem();

            const diff = difficulties[currentLevel];
            for (let i = 0; i < items.length; i++) {
                let item = items[i]; 
                // √Åp d·ª•ng Speed Modifier
                item.y += item.speed * activeBuffs.globalSpeedModifier;

                // Collision
                if (item.x < player.x + player.width && item.x + item.size > player.x && item.y < player.y + player.height && item.y + item.size > player.y) {
                    if (item.type === 'special') {
                        applyBuff(item.specialType);
                    } 
                    else if (item.isBad) {
                        score -= diff.penaltyHit; 
                        sessionMoney -= diff.moneyBad;
                        AudioSys.play('hit'); shakeCanvas();
                    } else {
                        score += 1; 
                        points += 10 * activeBuffs.scoreMultiplier; 
                        sessionMoney += diff.moneyGood * activeBuffs.moneyMultiplier;
                        AudioSys.play('eat');
                    }
                    items.splice(i, 1); i--; updateHUD(); continue;
                }
                
                if (item.y > canvas.height) {
                    if (item.type !== 'special' && !item.isBad) { score -= diff.penaltyMiss; updateHUD(); }
                    items.splice(i, 1); i--;
                }
            }
            if (score <= 0) endGame("H·∫æT M√ÅU!");
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (loadedAssets.char) ctx.drawImage(imgChar, player.x, player.y, player.width, player.height);
            else { ctx.fillStyle = 'blue'; ctx.fillRect(player.x, player.y, player.width, player.height); }

            items.forEach(item => {
                if (item.type === 'special') {
                    // V·∫Ω Special Item b·∫±ng Emoji
                    const info = SPECIAL_ITEMS_INFO[item.specialType];
                    ctx.font = "40px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    
                    // Glow effect
                    ctx.shadowColor = info.color; ctx.shadowBlur = 15;
                    ctx.fillText(info.icon, item.x + item.size/2, item.y + item.size/2);
                    ctx.shadowBlur = 0;
                } 
                else {
                    // V·∫Ω Item Th∆∞·ªùng
                    let imgToDraw = null;
                    if (item.isBad) { if (badImages.length > 0) imgToDraw = badImages[item.imgIndex % badImages.length]; } 
                    else { if (goodImages.length > 0) imgToDraw = goodImages[item.imgIndex % goodImages.length]; }
                    
                    if (imgToDraw && imgToDraw.complete) {
                        ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 4;
                        ctx.drawImage(imgToDraw, item.x, item.y, item.size, item.size); 
                        ctx.shadowBlur = 0;
                    } else {
                        ctx.font = "40px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        const txt = item.isBad ? DEFAULT_EMOJI_BAD : DEFAULT_EMOJI_GOOD;
                        ctx.fillText(txt, item.x + item.size/2, item.y + item.size/2);
                    }
                }
            });
        }

        function gameLoop() { if (isGameOver || isPaused) return; update(); draw(); gameLoopId = requestAnimationFrame(gameLoop); }

        function updateHUD() {
            const scoreEl = document.getElementById('scoreDisplay');
            scoreEl.innerText = score;
            scoreEl.className = score <= 5 ? "text-xl font-black text-red-600 animate-pulse" : "text-xl font-black text-orange-600";
            document.getElementById('pointsDisplay').innerText = points;
            const mEl = document.getElementById('sessionMoneyDisplay');
            mEl.innerText = (sessionMoney >= 0 ? "+" : "") + sessionMoney + "$";
            mEl.className = sessionMoney < 0 ? "text-xl font-black text-red-500" : "text-xl font-black text-green-600";
        }
        function updateTimerHUD() {
            const tEl = document.getElementById('timeDisplay'); tEl.innerText = timeLeft;
            tEl.className = timeLeft <= 10 ? "text-xl font-black text-red-600 animate-ping" : "text-xl font-black text-purple-600";
        }

        function endGame(reason) {
            if (isGameOver) return;
            isGameOver = true;
            cancelAnimationFrame(gameLoopId); clearInterval(timerInterval);
            AudioSys.play('gameover');

            let finalBalance = playerData.money + sessionMoney;
            if (finalBalance < 0) finalBalance = 0;
            playerData.money = finalBalance;
            if (points > playerData.highScores[currentLevel]) playerData.highScores[currentLevel] = points;
            saveData();

            document.getElementById('hud').classList.add('hidden'); document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('gameOverMenu').classList.remove('hidden');
            
            document.getElementById('endReason').innerText = reason;
            document.getElementById('finalScore').innerText = points;
            const earnEl = document.getElementById('finalMoneyEarned');
            earnEl.innerText = (sessionMoney >= 0 ? "+" : "") + sessionMoney + "$";
            earnEl.className = sessionMoney < 0 ? "font-bold text-red-500" : "font-bold text-green-600";
            document.getElementById('finalTotalMoney').innerText = playerData.money + "$";
        }

        function backToMain() {
            document.getElementById('difficultyMenu').classList.add('hidden'); document.getElementById('shopMenu').classList.add('hidden');
            document.getElementById('gameOverMenu').classList.add('hidden'); document.getElementById('hud').classList.add('hidden');
            document.getElementById('pauseBtn').classList.add('hidden'); document.getElementById('mainMenu').classList.remove('hidden');
            init();
        }
        function showDifficultyMenu() { document.getElementById('mainMenu').classList.add('hidden'); document.getElementById('difficultyMenu').classList.remove('hidden'); init(); }
        function replayGame() { startGame(currentLevel); }
        function shakeCanvas() { canvas.style.transform = 'translate(5px, 5px)'; setTimeout(() => { canvas.style.transform = 'translate(-5px, -5px)'; setTimeout(() => canvas.style.transform = 'translate(0, 0)', 50); }, 50); }

        init();
    </script>
</body>
</html>